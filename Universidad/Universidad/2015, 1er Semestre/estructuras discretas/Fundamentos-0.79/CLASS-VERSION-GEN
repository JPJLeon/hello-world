#! /bin/sh

# CLASS-VERSION-GEN
#
# Copyright (c) 2013-2014 Horst H. von Brand
# Bajo licencia MIT. Vea LICENSE-MIT para detalles


VF=version
CVT=class-version.tex
CVF=CLASS-VERSION-FILE

DEF_VER=0.78

if test -f version
then
	VN=$(cat version) || VN="$DEF_VER"
elif git rev-parse &> /dev/null
then
	VN=$(git describe --match "v[0-9]*" --dirty 2> /dev/null)
else
	VN="$DEF_VER"
fi

VN=$(expr "$VN" : v*'\(.*\)')

if test -r $CVF
then
	VC=$(sed -e 's/^CLASS_VERSION = //' $CVF)
else
	VC=unset
fi

test "$VN" = "$VC" || {
	echo >&2 "Class version: $VN"
	rm -f $CVF $CVT

	echo "CLASS_VERSION = $VN" > $CVF

	echo "% This file is autogenerated, don't edit" > $CVT
	echo >> $CVT
	VNN=$(echo $VN | sed -e 's;-dirty$; (dirty);')
	echo "\\newcommand{\\classversion}{$VNN}" >> $CVT
}
